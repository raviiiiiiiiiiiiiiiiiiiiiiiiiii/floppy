<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Floppy F4ck ‚Äî Game Maker</title>
<style>
  :root{--bg:#070707;--panel:#0f0f0f;--accent:#13e37a;--muted:#9aa}
  html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:Inter,system-ui,Arial}
  .wrap{max-width:480px;margin:12px auto;padding:12px}
  h1{margin:4px 0;font-size:22px;color:var(--accent)}
  .subtitle{color:var(--muted);font-size:13px;margin-bottom:10px}
  .card{background:var(--panel);padding:12px;border-radius:10px}
  label{display:block;margin-top:8px;color:var(--muted);font-size:13px}
  input[type=file], input[type=text]{width:100%;padding:8px;border-radius:8px;background:#070707;border:1px solid #222;color:#fff;margin-top:6px}
  button{background:var(--accent);border:none;color:#021;padding:10px 12px;border-radius:8px;cursor:pointer;font-weight:700;margin-top:10px}
  button.ghost{background:transparent;border:1px solid #222;color:var(--muted)}
  canvas{display:block;width:100%;height:auto;border-radius:10px;background:#000;margin-top:12px}
  .overlayTop{position:fixed;left:0;right:0;top:8px;display:flex;justify-content:space-between;padding:8px 14px;pointer-events:none}
  .scoreBox{pointer-events:auto;background:rgba(0,0,0,0.35);padding:6px 10px;border-radius:10px;font-weight:800;font-size:20px}
  .controls{pointer-events:auto;display:flex;gap:8px;align-items:center}
  .small{font-size:12px;color:var(--muted);margin-top:8px}
  #gameOverUI{position:fixed;left:0;right:0;top:24%;display:none;align-items:center;flex-direction:column;pointer-events:auto}
  #gameOverUI .box{background:rgba(0,0,0,0.8);padding:14px;border-radius:10px;display:inline-block;text-align:center}
  #gameOverUI img{max-width:220px;border-radius:8px;display:block;margin:0 auto}
  footer{color:var(--muted);font-size:12px;margin-top:12px;text-align:center}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Floppy F4ck ‚Äî Maker</h1>
    <div class="subtitle">Build a portrait Flappy-style game. Upload, generate, play. Restart respawns (no reload).</div>

    <div id="creator" class="card">
      <label>Character image (required)</label>
      <input id="playerFile" type="file" accept="image/*" />

      <label>Obstacle image (required)</label>
      <input id="pipeFile" type="file" accept="image/*" />

      <label>Background image (optional)</label>
      <input id="bgFile" type="file" accept="image/*" />

      <label>Background music (mp3) ‚Äî optional</label>
      <input id="bgmFile" type="file" accept="audio/*" />

      <label>Death sound (mp3) ‚Äî optional</label>
      <input id="deadFile" type="file" accept="audio/*" />

      <label>Game-over text</label>
      <input id="goText" type="text" placeholder="You lost! Try again." />

      <label>Game-over image (optional)</label>
      <input id="goFile" type="file" accept="image/*" />

      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="genBtn">Generate & Play</button>
        <button id="previewBtn" class="ghost">Preview (no audio)</button>
      </div>

      <div class="small">Why should developers have all the fun? Upload a meme, make people suffer. Keep uploads small for best performance.</div>
    </div>

    <canvas id="gameCanvas" width="360" height="640"></canvas>
    <div id="shareControls" style="display:none; text-align:center; margin-top:10px;">
  <button id="saveBtn" class="ghost" style="width:100%;font-size:14px;">
    Save & Share üîó
  </button>
</div>

    <div class="overlayTop" id="overlayTop" style="display:none">
      <div class="scoreBox" id="scoreBox">0</div>
      <div class="controls">
        <button id="backBtn" class="ghost">Back</button>
      </div>
    </div>

    <div id="gameOverUI">
      <div class="box">
        <div id="goImgWrap"></div>
        <div id="goTextShow" style="font-weight:700;font-size:18px;margin-top:10px"></div>
        <div style="margin-top:12px;display:flex;gap:8px;justify-content:center">
          <button id="restartBtn">RESTART</button>
          <button id="menuBtn" class="ghost">EDIT</button>
        </div>
      </div>
    </div>

    <footer>Why should developers have all the fun? Make and play. ‚úåÔ∏è</footer>
  </div>

<script>
const API_BASE = "https://floppy-production.up.railway.app";

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const creator = document.getElementById('creator');
const overlayTop = document.getElementById('overlayTop');
const scoreBox = document.getElementById('scoreBox');
const gameOverUI = document.getElementById('gameOverUI');
const goImgWrap = document.getElementById('goImgWrap');
const goTextShow = document.getElementById('goTextShow');

const playerFile = document.getElementById('playerFile');
const pipeFile = document.getElementById('pipeFile');
const bgFile = document.getElementById('bgFile');
const bgmFile = document.getElementById('bgmFile');
const deadFile = document.getElementById('deadFile');
const goFile = document.getElementById('goFile');
const goTextInput = document.getElementById('goText');
const genBtn = document.getElementById('genBtn');
const previewBtn = document.getElementById('previewBtn');
const restartBtn = document.getElementById('restartBtn');
const menuBtn = document.getElementById('menuBtn');
const backBtn = document.getElementById('backBtn');
const saveBtn = document.getElementById('saveBtn');

let images = { player: new Image(), pipe: new Image(), bg: new Image(), go: new Image() };
let sounds = { bgm: null, dead: null };
let state = null;
let lastTime = 0;
let rafId = null;
let startedAudio = false;

const PHYS = {
  gravity: 1000,
  flapV: -320,
  maxFall: 900,
  pipeSpeedBase: 140,
  pipeAccel: 0.02,
  gap: 180,
  spawnInterval: 1.6,
  playerX: 90,
  playerWidthRatio: 0.14
};

function fitCanvas(){
  canvas.style.display = "block";
  canvas.width = 360;
  canvas.height = 640;
}

function fileToURL(file){
  return new Promise(res => {
    if(!file){ res(null); return; }
    const r = new FileReader();
    r.onload = ()=> res(r.result);
    r.readAsDataURL(file);
  });
}

function makeState(goText){
  return {
    goText,
    pipes: [],
    player: { x: PHYS.playerX, y: 250, vy: 0 },
    dead: false,
    tSpawn: 0,
    pipeSpeed: PHYS.pipeSpeedBase,
    score: 0
  };
}

function reset(){
  state = makeState(goTextInput.value || "Game Over!");
  goImgWrap.innerHTML = "";
  goTextShow.textContent = "";
  scoreBox.textContent = "0";
  gameOverUI.style.display = "none";
  state.dead = false;
  state.score = 0;
}

function die(){
  state.dead = true;
  if(sounds.bgm){
    try{sounds.bgm.pause();}catch(e){}
  }
  if(sounds.dead){
    try{sounds.dead.play();}catch(e){}
  }
  goTextShow.textContent = state.goText;
  gameOverUI.style.display = "flex";
}

function loop(ts){
  if(!state){ return rafId = requestAnimationFrame(loop); }

  const dt = (ts-lastTime)/1000;
  lastTime = ts;

  ctx.clearRect(0,0,canvas.width,canvas.height);

  if(images.bg.src) ctx.drawImage(images.bg,0,0,canvas.width,canvas.height);

  if(!state.dead){
    state.player.vy += PHYS.gravity * dt;
    state.player.vy = Math.min(state.player.vy, PHYS.maxFall);
    state.player.y += state.player.vy * dt;

    state.tSpawn += dt;
    if(state.tSpawn >= PHYS.spawnInterval){
      state.tSpawn = 0;
      const top = Math.random()*200+60;
      state.pipes.push({x:canvas.width, top});
    }

    state.pipeSpeed += PHYS.pipeAccel;
  }

  for(const p of state.pipes){
    if(!state.dead) p.x -= state.pipeSpeed * dt;
    ctx.drawImage(images.pipe,p.x,0,60,p.top);
    ctx.drawImage(images.pipe,p.x,p.top+PHYS.gap,60,canvas.height-p.top-PHYS.gap);

    if(
      state.player.x+40>p.x &&
      state.player.x<p.x+60 &&
      (state.player.y<p.top || state.player.y+40>p.top+PHYS.gap)
    ) die();

    if(p.x+60 < state.player.x && !p.scored){
      p.scored=true;
      state.score++;
      scoreBox.textContent=state.score;
    }
  }

  if(state.player.y>canvas.height-40 || state.player.y<0) die();

  ctx.drawImage(images.player,state.player.x,state.player.y,40,40);

  rafId = requestAnimationFrame(loop);
}

function flap(){
  if(!state) return;
  if(state.dead){
    reset();
    return;
  }
  if(sounds.bgm && !startedAudio){
    startedAudio = true;
    sounds.bgm.play().catch(()=>{});
  }
  state.player.vy = PHYS.flapV;
}

// ‚úÖ Generate Game
genBtn.addEventListener("click", async ()=>{
  images.player.src = await fileToURL(playerFile.files[0]);
  images.pipe.src = await fileToURL(pipeFile.files[0]);
  images.bg.src   = await fileToURL(bgFile.files[0]);
  images.go.src   = await fileToURL(goFile.files[0]);

  sounds.bgm = (await fileToURL(bgmFile.files[0])) ? new Audio(await fileToURL(bgmFile.files[0])) : null;
  sounds.dead = (await fileToURL(deadFile.files[0])) ? new Audio(await fileToURL(deadFile.files[0])) : null;

  fitCanvas();
  reset();
  creator.style.display="none";
  overlayTop.style.display="flex";
  canvas.addEventListener("mousedown",flap);
  canvas.addEventListener("touchstart",flap);

  if(!rafId) rafId=requestAnimationFrame(loop);
});

// ‚úÖ Save Game ‚Üí API
saveBtn.addEventListener("click", async()=>{
  if(!state) return;
  const payload = {
    player: images.player.src,
    pipe: images.pipe.src,
    bg: images.bg.src,
    bgm: sounds.bgm?.src || null,
    dead: sounds.dead?.src || null,
    goImg: images.go?.src || null,
    goText: state.goText
  };
  const res = await fetch(`${API_BASE}/api/save`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(payload)
  });
  const data = await res.json();
  if(data?.id){
    const link = `${window.location.origin}/play.html?id=${data.id}`;
    prompt("Share this Game:",link);
  }
});

// ‚úÖ Restart
restartBtn.addEventListener("click", reset);

// ‚úÖ Back to editor
menuBtn.addEventListener("click",()=>{
  if(sounds.bgm){sounds.bgm.pause();}
  creator.style.display="block";
  overlayTop.style.display="none";
  gameOverUI.style.display="none";
});

// ‚úÖ Init
overlayTop.style.display="none";
gameOverUI.style.display="none";
rafId=requestAnimationFrame(loop);
</script>
  
</body>
</html>  
