<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Floppy F4ck Maker</title>
<style>
    body { margin:0; font-family:Arial; background:#000; color:white; text-align:center; }
    #menu { padding:20px; }
    input { display:block; margin:10px auto; }
    #gameCanvas { display:none; background:black; }
    #audioToggle { position:absolute; top:10px; right:10px; font-size:28px; cursor:pointer; display:none; }
</style>
</head>
<body>

<div id="menu">
    <h2>Create Your Game</h2>
    <label>Character Image</label><input type="file" id="charImg" accept="image/*">
    <label>Pipe/Image Obstacle</label><input type="file" id="obImg" accept="image/*">
    <label>Background</label><input type="file" id="bgImg" accept="image/*">
    <label>Game Music</label><input type="file" id="bgMusic" accept="audio/*">
    <label>Death Sound</label><input type="file" id="deathMusic" accept="audio/*">
    <label>Game Over Text</label><input type="text" id="goText" placeholder="Game Over!">
    <button onclick="generateGame()">Generate Game</button>
</div>

<canvas id="gameCanvas" width="360" height="600"></canvas>
<div id="audioToggle">ðŸ”Š</div>

<script>
let canvas = document.getElementById("gameCanvas");
let ctx = canvas.getContext("2d");

let player, pipes, score, gameOver, bg, charImg, obImg;
let gravity = 0.4;
let jumpPower = -8;
let pipeSpeed = 2;
let gap = 140; // âœ… Increased gap
let pipeWidth = 70; // âœ… Smaller pipes
let audioEnabled = true;

let bgSound = new Audio();
let deathSound = new Audio();

document.getElementById("audioToggle").onclick = () => {
    audioEnabled = !audioEnabled;
    document.getElementById("audioToggle").innerText = audioEnabled ? "ðŸ”Š" : "ðŸ”‡";
    if(audioEnabled) bgSound.play(); else bgSound.pause();
};

// Load File to Base64
function toBase64(file, cb) {
    if (!file) return cb("");
    let r = new FileReader();
    r.onload = ()=> cb(r.result);
    r.readAsDataURL(file);
}

function generateGame() {
    Promise.all([
        new Promise(res => toBase64(document.getElementById("charImg").files[0], res)),
        new Promise(res => toBase64(document.getElementById("obImg").files[0], res)),
        new Promise(res => toBase64(document.getElementById("bgImg").files[0], res)),
        new Promise(res => toBase64(document.getElementById("bgMusic").files[0], res)),
        new Promise(res => toBase64(document.getElementById("deathMusic").files[0], res)),
    ]).then(([ci, oi, bi, bm, dm]) => {
        
        let data = {
            ci, oi, bi, bm, dm,
            go: document.getElementById("goText").value
        };

        let id = "g" + Date.now();
        localStorage.setItem(id, JSON.stringify(data));

        location.href = location.origin + location.pathname + "?id=" + id;
    });
}

function loadGame(data) {
    charImg = new Image(); charImg.src = data.ci;
    obImg = new Image(); obImg.src = data.oi;
    bg = new Image(); bg.src = data.bi;

    bgSound.src = data.bm;
    deathSound.src = data.dm;

    if(audioEnabled && bgSound.src) bgSound.play();

    startGame(data.go);
}

function startGame(goText){
    document.getElementById("menu").style.display="none";
    canvas.style.display="block";
    document.getElementById("audioToggle").style.display="block";

    player = { x:100, y:300, vy:0 };
    pipes = [];
    score = 0;
    gameOver = false;

    canvas.addEventListener("touchstart", ()=> player.vy = jumpPower);
    canvas.addEventListener("mousedown", ()=> player.vy = jumpPower);

    setInterval(()=> {
        let topH = Math.random()*250 + 50;
        pipes.push({ x:360, top: topH });
    }, 1600);

    requestAnimationFrame(()=>loop(goText));
}

function loop(goText){
    if (gameOver) return drawGameOver(goText);

    ctx.clearRect(0,0,360,600);

    if(bg.src) ctx.drawImage(bg, 0,0,360,600);

    // Player
    player.vy += gravity;
    player.y += player.vy;
    ctx.drawImage(charImg, player.x, player.y, 40,40);

    // Pipes
    for(let p of pipes){
        p.x -= pipeSpeed;

        ctx.drawImage(obImg, p.x, 0, pipeWidth, p.top);
        ctx.drawImage(obImg, p.x, p.top + gap, pipeWidth, 600 - p.top - gap);

        if(player.x+40 > p.x && player.x < p.x+pipeWidth &&
          (player.y < p.top || player.y+40 > p.top+gap)) {
            gameOver = true;
            if(audioEnabled) { bgSound.pause(); deathSound.play(); }
        }

        if(p.x === player.x) score++;
    }

    if(player.y > 560 || player.y < 0) gameOver = true;

    ctx.fillStyle="white"; ctx.font="24px Arial";
    ctx.fillText("Score: "+score, 10,30);

    requestAnimationFrame(()=>loop(goText));
}

function drawGameOver(goText){
    ctx.fillStyle="rgba(0,0,0,0.5)";
    ctx.fillRect(0,0,360,600);
    ctx.fillStyle="white";
    ctx.font="26px Arial";
    ctx.fillText(goText || "Game Over!", 80,300);
    ctx.font="16px Arial";
    ctx.fillText("Tap to Restart", 120,340);

    canvas.onclick = ()=>location.reload();
}

// Check URL id
const id = new URLSearchParams(location.search).get("id");
if(id){
    let saved = localStorage.getItem(id);
    if(saved) loadGame(JSON.parse(saved));
}
</script>

</body>
</html>
